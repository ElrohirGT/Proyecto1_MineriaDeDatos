---
title: "CineVision - Análisis Exploratorio"
author: "Flavio Galán, José Prince"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

[Repositorio](https://github.com/ElrohirGT/Proyecto1_MineriaDeDatos.git)

## Resumen del conjunto de Datos

Los datos tienen la siguiente forma:

```{r}
datos <- read.csv("data/movies.csv")
summary(datos)
```

## Tipos de cada variable

1.  **Id**: Cuantitativa discreta

```{r normal distribution1}
library(ggplot2)

datos$id <- suppressWarnings(as.numeric(as.character(datos$id)))
datosX <- datos[!is.na(datos$id), ]

if (nrow(datos) > 0) {
  
  ggplot(datosX, aes(x = id)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
    stat_function(fun = dnorm, args = list(mean = mean(datosX$id, na.rm = TRUE),
                                           sd = sd(datos$id, na.rm = TRUE)),
                  color = "red", size = 1) +
    ggtitle("Histograma para Id")

  qqnorm(datosX$id, main = "QQ Plot de Id")
  qqline(datosX$id, col = "red", lwd = 2)
  
} else {
  print("No hay datos válidos en actorsPopularity después de la conversión.")
}
```

Para la distribución de esta variable se puede ver que su distribución no se asemeja en nada a una distribución normal, podemos ver en el histograma un sesgo hacia la derecha y en el QQ Plot los datos se alejan de la directriz.

2.  **popularity**: Cuantitativa continua

```{r normal distribution2}
ggplot(datos, aes(x = popularity)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$popularity, na.rm = TRUE),
                                         se = sd(datos$popularity, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para popularity")

qqnorm(datos$popularity, main = "QQ Plot de popularity")
qqline(datos$popularity, col = "red", lwd = 2)
```

Para esta variable, su distribución no termina de asemejarse a una distribución normal, ni en el histograma ni en el QQ Plot.

3.  **budget**: Cuantitativa discreta (no se incluyen centavos)

```{r normal distribution3}
ggplot(datos, aes(x = budget)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$budget, na.rm = TRUE),
                                         se = sd(datos$budget, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para budget")

qqnorm(datos$budget, main = "QQ Plot de budget")
qqline(datos$budget, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

4.  **revenue**: Cuantitativa discreta (no se incluyen centavos)

```{r normal distribution 4}
ggplot(datos, aes(x = revenue)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$revenue, na.rm = TRUE),
                                         se = sd(datos$revenue, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para revenue")

qqnorm(datos$revenue, main = "QQ Plot de revenue")
qqline(datos$revenue, col = "red", lwd = 2)
```

La distribución para esta variable demuestra que sus datos estan en la directriz del QQ Plot, pero viendo la distribución en el histograma se puede apreciar que su distribución es uniforme.

5.  **original_title**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de apariciones por cada una de los titulos originales de las peliculas.

```{r frecuency table1}
library(dplyr)
library(stringr)

frecuency <- datos %>% count(originalTitle) %>% arrange(desc(n)) %>%
  filter(!str_starts(originalTitle, "<") & !str_starts(originalTitle, "2") & !str_starts(originalTitle, "3D") & !str_starts(originalTitle, "BU"))
colnames(frecuency)[1] = "Titulo original"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

6.  **originalLanguage**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de apariciones por cada una de los Idiomas originales de las peliculas.

```{r frecuency table2}
frecuency <- datos %>% count(originalLanguage) %>% arrange(desc(n))
colnames(frecuency)[1] = "Idioma original"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

7.  **title**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de apariciones por cada una de los titulos de las peliculas.

```{r frecuency table3}
frecuency <- datos %>% count(title) %>% arrange(desc(n))
colnames(frecuency)[1] = "Titutlo"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

8.  **homePage**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de apariciones por cada una de las home pages de las peliculas.

```{r frecuency table4}
frecuency <- datos %>% count(homePage) %>% arrange(desc(n)) %>% filter(!is.na(homePage))
colnames(frecuency)[1] = "Home Page"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

9.  **video**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de peliculas que cuentan o no con un video.

```{r frecuency table5}
frecuency <- datos %>% count(video) %>% arrange(desc(n))
colnames(frecuency)[1] = "Video"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

10. **director**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de veces que un director a dirigido una pelicula.

```{r frecuency table6}
library(tidyr)
frecuency <- datos %>%
  separate_rows(director, sep = "\\|") %>%  
  count(director) %>%                       
  arrange(desc(n))                          

colnames(frecuency)[1] = "Director"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

11. **runtime**: Cuantitativa discreta

```{r normal distribution6}
ggplot(datos, aes(x = runtime)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$runtime, na.rm = TRUE),
                                         se = sd(datos$runtime, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para runtime")

qqnorm(datos$runtime, main = "QQ Plot de runtime")
qqline(datos$runtime, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

12. **genres**: Cualitativa nominal

La siguiente tabla de frecuencia muestra los posibles géneros que puede tener una pelicula.

```{r frecuency table7}
frecuency <- datos %>%
  separate_rows(genres, sep = "\\|") %>%  
  count(genres) %>%                       
  arrange(desc(n))  

colnames(frecuency)[1] = "Género"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

13. **genresAmount**: Cuantitativa discreta

```{r normal distribution7}
ggplot(datos, aes(x = genresAmount)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$genresAmount, na.rm = TRUE),
                                         se = sd(datos$genresAmount, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para genresAmount")

qqnorm(datos$runtime, main = "QQ Plot de genresAmount")
qqline(datos$runtime, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

14. **productionCompany**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad total de peliculas que ha hecho cada productora.

```{r frecuency table8}
frecuency <- datos %>% count(productionCompany) %>% arrange(desc(n))
colnames(frecuency)[1] = "Compañía productora"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

15. **productionCoAmount**: Cuantitativa discreta

```{r normal distribution8}
ggplot(datos, aes(x = productionCoAmount)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$productionCoAmount, na.rm = TRUE),
                                         se = sd(datos$productionCoAmount, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para productionCoAmount")

qqnorm(datos$productionCoAmount, main = "QQ Plot de productionCoAmount")
qqline(datos$productionCoAmount, col = "red", lwd = 2)
```

La distribución para esta variable demuestra que sus datos estan en la directriz del QQ Plot, pero viendo la distribución en el histograma se puede apreciar que su distribución es uniforme.

16. **productionCompanyCountry**: Cualitativa nominal

La siguiente tabla de frecuencia muestra el número de productoras que se ubican en determinados países.

```{r frecuency table9}
frecuency <- datos %>%
  separate_rows(productionCompanyCountry, sep = "\\|") %>%  
  count(productionCompanyCountry) %>%                       
  arrange(desc(n))  %>% 
  filter(productionCompanyCountry != "" & !is.na(productionCompanyCountry))

colnames(frecuency)[1] = "País de Compañía productora"
colnames(frecuency)[2] = "Cantidad"

head(frecuency)
```

17. **productionCountry**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad de veces que se ha producido una pelicula en ese país.

```{r frecuency table9+1}
frecuency <- datos %>%
  separate_rows(productionCountry, sep = "\\|") %>%  
  count(productionCountry) %>%                       
  arrange(desc(n)) %>% 
  filter(productionCountry != "")
colnames(frecuency)[1] = "País de producción"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

18. **productionCountriesAmount**: Cuantitativa discreta

```{r normal distribution9}
datos$productionCountriesAmount <- suppressWarnings(as.numeric(as.character(datos$productionCountriesAmount)))
datosx <- datos[!is.na(datos$productionCountriesAmount), ]

if (nrow(datosx) > 0) {
  
  ggplot(datosx, aes(x = productionCountriesAmount)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
    stat_function(fun = dnorm, args = list(mean = mean(datosx$productionCountriesAmount, na.rm = TRUE),
                                           sd = sd(datosx$productionCountriesAmount, na.rm = TRUE)),
                  color = "red", size = 1) +
    ggtitle("Histograma para productionCountriesAmount")

  qqnorm(datosx$productionCountriesAmount, main = "QQ Plot de productionCountriesAmount")
  qqline(datosx$productionCountriesAmount, col = "red", lwd = 2)
  
} else {
  print("No hay datos válidos en actorsPopularity después de la conversión.")
}
```

La distribución para esta variable demuestra que sus datos estan en la directriz del QQ Plot, pero viendo la distribución en el histograma se puede apreciar que su distribución es uniforme.

19. **releaseDate**: Cualitativa ordinal

La siguiente tabla de frecuencia muestra las fechas en las que se han lanzado las diferentes peliculas.

```{r frecuency table10}
frecuency <- datos %>%
  count(releaseDate) %>%                       
  arrange(desc(n))  

colnames(frecuency)[1] = "Fecha de lanzamiento"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

20. **voteCount**: Cuantitativa discreta

```{r normal distribution10}
ggplot(datos, aes(x = voteCount)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$voteCount, na.rm = TRUE),
                                         se = sd(datos$voteCount, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para voteCount")

qqnorm(datos$voteCount, main = "QQ Plot de voteCount")
qqline(datos$voteCount, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

21. **voteAvg**: Cuantitativa continua

```{r normal distribution11}
ggplot(datos, aes(x = voteAvg)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$voteAvg, na.rm = TRUE),
                                         se = sd(datos$voteAvg, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para voteAvg")

qqnorm(datos$voteAvg, main = "QQ Plot de voteAvg")
qqline(datos$voteAvg, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

22. **actors**: Cualitativa nominal

La siguiente tabla de frecuencia muestra el nombre de los actores, indicando cuantas veces ha actuado.

```{r frecuency table11}
frecuency <- datos %>%
  separate_rows(actors, sep = "\\|") %>%  
  count(actors) %>%                       
  arrange(desc(n)) %>%
  filter(actors != FALSE)

colnames(frecuency)[1] = "Actor"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

23. **actorsPopularity**: Cuantitativa continua

```{r normal distribution12}
datos$actorsPopularity <- suppressWarnings(as.numeric(as.character(datos$actorsPopularity)))
datosX <- datos[!is.na(datos$actorsPopularity), ]

if (nrow(datosX) > 0) {
  
  ggplot(datosX, aes(x = actorsPopularity)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
    stat_function(fun = dnorm, args = list(mean = mean(datosX$actorsPopularity, na.rm = TRUE),
                                           sd = sd(datosX$actorsPopularity, na.rm = TRUE)),
                  color = "red", size = 1) +
    ggtitle("Histograma para actorsPopularity")

  qqnorm(datosX$actorsPopularity, main = "QQ Plot de actorsPopularity")
  qqline(datosX$actorsPopularity, col = "red", lwd = 2)
  
} else {
  print("No hay datos válidos en actorsPopularity después de la conversión.")
}
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

24. **actorsCharacter**: Cualitativa nominal

La siguiente tabla de frecuencia muestra la cantidad de apariciones que ha tenido un personaje indicando si fue solo por voz o si el personaje no fue acreditado.

```{r frecuency table12}
frecuency <- datos %>%
  separate_rows(actorsCharacter, sep = "\\|") %>%  
  count(actorsCharacter) %>%                       
  arrange(desc(n))  %>%
  filter(actorsCharacter != "" & actorsCharacter != "(voice)" & actorsCharacter != "(uncredited)")

colnames(frecuency)[1] = "Personaje"
colnames(frecuency)[2] = "Cantidad"
head(frecuency)
```

25. **actorsAmount**: Cuantitativa discreta

```{r normal distribution13}
ggplot(datos, aes(x = actorsAmount)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(datos$actorsAmount, na.rm = TRUE),
                                         se = sd(datos$actorsAmount, na.rm = TRUE)),
                color = "red", size = 1) +
  ggtitle("Histograma para actorsAmount")

qqnorm(datos$actorsAmount, main = "QQ Plot de actorsAmount")
qqline(datos$actorsAmount, col = "red", lwd = 2)
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

26. **CastWomenAmount**: Cuantitativa discreta

```{r normal distribution14}
datos$castWomenAmount <- suppressWarnings(as.numeric(as.character(datos$castWomenAmount)))
datosX <- datos[!is.na(datos$castWomenAmount), ]

if (nrow(datosX) > 0) {
  
  ggplot(datosX, aes(x = castWomenAmount)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
    stat_function(fun = dnorm, args = list(mean = mean(datosX$castWomenAmount, na.rm = TRUE),
                                           sd = sd(datosX$castWomenAmount, na.rm = TRUE)),
                  color = "red", size = 1) +
    ggtitle("Histograma para castWomanAmount")

  qqnorm(datosX$castWomenAmount, main = "QQ Plot de castWomenAmount")
  qqline(datosX$castWomenAmount, col = "red", lwd = 2)
  
} else {
  print("No hay datos válidos en castMenAmount después de la conversión.")
}
```

Para esta variable se nota a simple vista que los datos no pertenecen a una distribución normal, los datos (ni en el histograma como en el QQ Plot) se ajustan a una distribución normal.

27. **CastMenAmount**: Cuantitativa discreta

```{r normal distribution15}
datos$castMenAmount <- suppressWarnings(as.numeric(as.character(datos$castMenAmount)))
datosX <- datos[!is.na(datos$castMenAmount), ]

if (nrow(datosX) > 0) {
  
  ggplot(datosX, aes(x = castMenAmount)) +
    geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
    stat_function(fun = dnorm, args = list(mean = mean(datosX$castMenAmount, na.rm = TRUE),
                                           sd = sd(datosX$castMenAmount, na.rm = TRUE)),
                  color = "red", size = 1) +
    ggtitle("Histograma para castMenAmount")

  qqnorm(datosX$castMenAmount, main = "QQ Plot de castMenAmount")
  qqline(datosX$castMenAmount, col = "red", lwd = 2)
  
} else {
  print("No hay datos válidos en castMenAmount después de la conversión.")
}

```

Se puede ver por el QQ plot que los datos se asemejan un poco a una distribución normal pero se puede observar por la cola derecha de los datos, que no se ajustan a la directriz de la gráfica y esa curva que se crea esta bastante pronunciada.
Esto demuestra que la variable castMenAmount no se ajusta a una distribución normal.

## Preguntas

### ¿Cuáles son las 10 películas que contaron con más presupuesto?

```{r Pregunta 1}
ordered_movies <- datos[order(datos$budget, decreasing = TRUE),]
top_10_expensive_movies <- head(ordered_movies, n=10)
top_10_expensive_movies <- top_10_expensive_movies[c("title", "budget")]

colnames(top_10_expensive_movies)[1] = "Título"
colnames(top_10_expensive_movies)[2] = "Presupuesto"

top_10_expensive_movies
```

Como se puede ver la película con mayor presupuesto es: `r top_10_expensive_movies$Título[1]` con un presupuesto de: `r top_10_expensive_movies$Presupuesto[1]` dólares!
Mientras que la última película dentro del top 10 es: `r top_10_expensive_movies$Título[10]` con un presupuesto de $`r top_10_expensive_movies$Presupuesto[10]`.

### ¿Cuáles son las 10 películas que más ingresos tuvieron?

```{r Pregunta 2}
ordered_movies <- datos[order(datos$revenue, decreasing = TRUE),]
top_10_expensive_movies <- head(ordered_movies, n=10)
top_10_expensive_movies <- top_10_expensive_movies[c("title", "revenue")]

colnames(top_10_expensive_movies)[1] = "Título"
colnames(top_10_expensive_movies)[2] = "Ingresos"

top_10_expensive_movies
```

Como se puede ver la película con mayores ingresos es: `r top_10_expensive_movies$Título[1]` con una cantidad de: `r top_10_expensive_movies$Ingresos[1]` dólares!
Mientras que la última película dentro del top 10 es: `r top_10_expensive_movies$Título[10]` con un ingresos de $`r top_10_expensive_movies$Ingresos[10]`.

### ¿Cuál es la película que más votos tuvo?

```{r Pregunta 3}
ordered_voted_movies <- datos[order(datos$voteCount, decreasing = TRUE),]
top_voted_movie <- head(ordered_voted_movies, n=1)
```

La película que más votos tuvo es: `r top_voted_movie$title[1]` con una cantidad de votos igual a: `r top_voted_movie$voteCount[1]`.

### ¿Cuál es la peor película de acuerdo a los votos de todos los usuarios?

```{r Pregunta 4}
ordered_voted_movies <- datos[order(datos$voteCount, decreasing = FALSE),]
worst_rated_movie <- head(ordered_voted_movies, n=1)
```

La película que menos votos tuvo es: `r worst_rated_movie$title[1]` con una cantidad de votos igual a: `r worst_rated_movie$voteCount[1]`.

### ¿Cuántas películas se hicieron en cada año? ¿En qué año se hicieron más películas? Haga un gráfico de barras

```{r Pregunta 5}
datos$year <- substr(datos$releaseDate, start = 1, stop = 4)
movies_by_year <- aggregate(datos[,c("year")], by=list(datos$year), FUN="length")

colnames(movies_by_year)[1] = "Año"
colnames(movies_by_year)[2] = "# Películas"

vec <- movies_by_year$`# Películas`
names(vec) <- movies_by_year$Año
barplot(vec, main="Películas por Año", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))

movies_by_year <- movies_by_year[order(movies_by_year$`# Películas`, decreasing = TRUE),]
max_movie_count_in_years <- movies_by_year$`# Películas`[1]

```

La tendencia en general de las películas ha ido en aumento conforme pasan los años, los demás datos de 2000 hacia atrás son más y más bajos.

En el año en donde más películas se han hecho es en el `r movies_by_year$Año[1]` con un total de: `r max_movie_count_in_years` películas que fueron lanzadas al cine.

### ¿Cuál es el género principal de las 20 películas más recientes? ¿Cuál es el género principal que predomina en el conjunto de datos? Represéntelo usando un gráfico.

```{r Pregunta 6.1}
datos$releaseDate <- as.Date(datos$releaseDate)
movies_by_date <- datos[order(datos$releaseDate, decreasing = TRUE),]

recent_movies_20 <- head(movies_by_date, n=20)
splitted_genres <- strsplit(recent_movies_20$genres, split = "|", fixed = TRUE)
movie_genres <- data.frame("", "")
names(movie_genres)<- c("ID", "GENRE")
for (idx in 1:20) {
  for (genre in splitted_genres[[idx]]) {
    temp <- c(recent_movies_20$title[idx], genre)
    names(temp) <- c("ID", "GENRE")
    movie_genres<- rbind(movie_genres, temp)
  }
}
movie_genres <- aggregate(movie_genres[,c("GENRE")], by=list(movie_genres$GENRE), FUN="length")
names(movie_genres) <- c("GENRE", "COUNT")
vec <- movie_genres$COUNT
names(vec) <- movie_genres$GENRE
barplot(vec, main="Géneros en las top 20 películas", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))
```

Los dos géneros más populares entre las últimas 20 películas son Comedia y Drama.
Mientras que en todos los datos:

```{r Pregunta 6.2}
library(data.table)
library(tidyr)

# Convert to data.table for efficiency
setDT(datos)
datos[, releaseDate := as.Date(releaseDate)]

# Order by release date in descending order
movies_by_date <- datos[order(-releaseDate)]

# Split genres and unnest
movies_by_date[, genres := strsplit(genres, split = "|", fixed = TRUE)]
movie_genres <- movies_by_date[, .(ID = title, GENRE = unlist(genres))]

# Count occurrences of each genre
movie_genres <- movie_genres[, .(COUNT = .N), by = GENRE]

# Create bar plot
barplot(setNames(movie_genres$COUNT, movie_genres$GENRE), 
        main = "Géneros generales", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

```

El género principal que predomina en todos los datos es Drama con una cantidad de películas del género igual a `r max(movie_genres$COUNT)`.

**¿A qué género principal pertenecen las películas más largas?**

```{r Pregunta 6.3}
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

limit <- 20
recent_movies_20 <- head(movies_by_runtime, n=limit)
splitted_genres <- strsplit(recent_movies_20$genres, split = "|", fixed = TRUE)
movie_genres <- data.frame("", "")
names(movie_genres)<- c("ID", "GENRE")
for (idx in 1:limit) {
  for (genre in splitted_genres[[idx]]) {
    temp <- c(recent_movies_20$title[idx], genre)
    names(temp) <- c("ID", "GENRE")
    movie_genres<- rbind(movie_genres, temp)
  }
}
movie_genres <- aggregate(movie_genres[,c("GENRE")], by=list(movie_genres$GENRE), FUN="length")
names(movie_genres) <- c("GENRE", "COUNT")
vec <- movie_genres$COUNT
names(vec) <- movie_genres$GENRE
barplot(vec, main="Géneros en las top 20 películas por duración", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))
```

En la gráfica de arriba podemos ver los géneros de las top 20 películas más largas, como se puede ver el género de drama es el más usado y por una gran ventaja.

### ¿Las películas de qué genero principal obtuvieron mayores ganancias?

```{r Pregunta 7}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, releaseDate := as.Date(releaseDate)]

# Order by release date in descending order
movies_by_date <- datos[order(-releaseDate)]

# Split genres and unnest
movies_by_date[, genres := strsplit(genres, split = "|", fixed = TRUE)]
movie_genres <- movies_by_date[, .(TITLE = title, GENRE = unlist(genres), REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = GENRE]

# Create bar plot
barplot(setNames(movie_genres$REVENUE, movie_genres$GENRE), 
        main = "Ingresos por género", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver en la gráfica, el género de película que mayores ingresos genera es Drama seguido de Comedia con $`r max(movie_genres$REVENUE)`y $`r ordered$REVENUE[2]` respectivamente.

### ¿La cantidad de actores influye en los ingresos de las películas? ¿Se han hecho películas con más actores en los últimos años?

```{r Pregunta 8.1}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(actorsAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(actorsAmount)]

# Split genres and unnest
movie_genres <- movies_by_date[, .(ACTORAMOUNT = actorsAmount, REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = ACTORAMOUNT]

# Create bar plot

barplot(setNames(movie_genres$REVENUE, movie_genres$ACTORAMOUNT), 
        main = "Ingresos por cantidad de actores", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]

```

Como se puede ver, una mayor cantidad de actores no implica una mayor cantidad de ingresos sin embargo se tiene un buen punto medio alrededor de 42 actores.

Con respecto a la cantidad de actores por años podemos reflejarlo en el siguiente gráfico:

```{r Pregunta 8.2}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(actorsAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(as.numeric(iconv(year, 'utf-8', 'ascii', sub='')))]

# Split genres and unnest
movie_genres <- movies_by_date[, .(ACTORAMOUNT = actorsAmount, YEAR = year)]

# Aggregate revenue by genre
movie_genres <- tail(movie_genres[, .(ACTORAMOUNT = sum(as.numeric(ACTORAMOUNT), na.rm = TRUE)), by = YEAR], n=30)

# Create bar plot

barplot(setNames(movie_genres$ACTORAMOUNT, movie_genres$YEAR), 
        main = "Cantidad de actores en películas por año", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver por la gráfica de barras la cantidad de actores por año sí ha ido creciendo año por año!
El 2022 no está completo dentro del dataset y por eso tiene resultados tan bajos.

### ¿Es posible que la cantidad de hombres y mujeres en el reparto influya en la popularidad y los ingresos de las películas?

```{r Pregunta 9}

movie_cast <- head(datos[, c('revenue','castMenAmount','castWomenAmount')],300)
movie_cast$diferencia_cast <- as.numeric(movie_cast$castMenAmount) - as.numeric(movie_cast$castWomenAmount)

plot(movie_cast$diferencia_cast, movie_cast$revenue,
     main = "Relación entre Diferencia de Género en el Elenco y Ganancias",
     xlab="Diferencia Hombres - Mujeres",
     ylab="Ganancias",
     col="blue",pch=19)
relation_rev <- cor(movie_cast$diferencia_cast, movie_cast$revenue, use = "complete.obs")

movie_castP <- head(datos[, c('popularity','castMenAmount','castWomenAmount')],300)
movie_castP$diferencia_cast <- as.numeric(movie_cast$castMenAmount) - as.numeric(movie_cast$castWomenAmount)

plot(movie_cast$diferencia_cast, movie_castP$popularity,
     main = "Relación entre Diferencia de Género en el Elenco y Popularidad",
     xlab="Diferencia Hombres - Mujeres",
     ylab="Popularidad",
     col="blue",pch=19)
```

Se puede ver que la correlación entre la diferencia de géneros y las ganancias es `r cor(movie_cast$diferencia_cast, movie_cast$revenue, use = "complete.obs")`, y la correlación entre la diferencia de géneros y la popularidad es `r cor(movie_cast$diferencia_cast, movie_castP$popularity, use = "complete.obs")`.
Esto indica que la cantidad de hombres y mujeres no influye en la ganancia ni popularidad de las peliculas.

### ¿Quiénes son los directores que hicieron las 20 películas mejor calificadas?

```{r Pregunta 10}
directors <- head(datos[, c('director','voteAvg')],20)
o_directors <- directors[order(directors$voteAvg, decreasing = TRUE),]
o_directors[, c('director')]
```

Estos son los 20 directores que han dirigido las peliculas mejores calificadas.

### ¿Cómo se correlacionan los presupuestos con los ingresos? ¿Los altos presupuestos significan altos ingresos? Haga los gráficos que necesite, histograma, diagrama de dispersión

```{r Pregunta 11}
incomes <- datos[, c('budget','revenue')]
plot(incomes$budget, incomes$revenue,
     main = "Relación entre Presupuesto y Ganancia",
     xlab="Presupuesto",
     ylab="Ganancia",
     col="blue",pch=19)
```

Se puede encontrar una relación entre el presupuesto y la ganancia.
Es apreciable como a mayor presupuesto hay una mayor ganancia en las peliculas.
Para corroborar este dato podemos calcular la variable de correlación que es `r cor(incomes$budget, incomes$revenue, use = "complete.obs")`, al ser cercanan a 1 nos inidica una correlación positiva entre el presupuesto y las ganancias.

### ¿Se asocian ciertos meses de lanzamiento con mejores ingresos?

```{r Pregunta 12}
library(dplyr)
library(ggplot2)
# Asegurar que releaseDate sea de tipo fecha
datos$releaseDate <- as.Date(datos$releaseDate)

# Seleccionar columnas y crear la columna 'mes'
months <- datos %>%
  select(revenue, releaseDate) %>%
  mutate(
    mes = format(releaseDate, "%m"),  # Extraer el mes
    ganancia = revenue  # Renombrar la columna
  ) %>%
  select(ganancia, mes)  # Reordenar columnas

table <- months %>%
  group_by(mes) %>%
  summarise(ganancia_promedio = mean(ganancia, na.rm = TRUE))

table$mes <- as.factor(table$mes)

ggplot(table, aes(x=mes, y=ganancia_promedio, fill = mes)) + geom_bar(stat="identity") +
  scale_fill_manual(values = c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", 
             "#8C564B", "#E377C2", "#7F7F7F", "#BCBD22", "#17BECF",
             "#AEC7E8", "#FFBB78")) +
  theme(legend.position = "none")

```

Se puede ver que los mejores meses para generar ingresos es en Junio y Mayo.

### ¿En qué meses se han visto los lanzamientos con mejores ingresos?¿cuantas películas, en promedio, se han lanzado por mes?

```{r Pregunta 13.1}
library(dplyr)
datos$releaseDate <- as.Date(datos$releaseDate)

datos$mes <- format(datos$releaseDate, "%m")

data <- datos[, c('revenue', 'mes')]
o_revenue <- head(data[order(data$revenue, decreasing = TRUE)],10)
o_revenueM <- o_revenue %>% group_by(mes) %>% summarize(total_revenue = sum(revenue))
o_revenueM$mes <- month.name[as.numeric(o_revenueM$mes)]
```

Los meses donde se han visto los mejores lanzamientos han sido: `r o_revenueM$mes`.

A continuación se muestra el promedio de peliculas por mes:

```{r Pregunta 13.2}
library(dplyr)
datos$releaseDate <- as.Date(datos$releaseDate)

datos$mes <- format(datos$releaseDate, "%m")
datos$year <- format(datos$releaseDate, "%Y")

year_count <- datos[, c('year')] %>% group_by(year) %>% summarise(count = n())
total_years <- nrow(year_count)

data <- datos[, c('title', 'mes')]
movie_count <- data %>% group_by(mes) %>% summarise(count = n())
movie_count$promedio_peliculas <- movie_count$count / as.numeric(total_years)

movie_count[, c('mes','promedio_peliculas')]
```

### ¿Cómo se correlacionan las calificaciones con el éxito comercial?

```{r Pregunta 14}
success <- datos[datos$revenue > budget * 3]
cor(success$voteAvg, success$revenue, use = "complete.obs")
```

Según el coeficiente de correlación entre las calificaciones y el éxito comercial de una pelicula, nos indica que no existe una clara relación entre estas variables y que pueden haber peliculas que no sean exitosos comerciales pero tengan buena calificación como exitos comerciales que tengan mala calificación, entre otros posibles casos.

### ¿Qué estrategias de marketing, como videos promocionales o páginas oficiales, generan mejores resultados?

```{r Pregunta 15}
library(ggplot2)
library(dplyr)
tabla1 <- datos[is.na(datos$homePage) & datos$video == TRUE, ]
tabla2 <- datos[!is.na(datos$homePage) & datos$video == FALSE, ]
tabla3 <- datos[!is.na(datos$homePage) & datos$video == TRUE, ]

promedio1 <- mean(tabla1$revenue, na.rm = TRUE)
promedio2 <- mean(tabla2$revenue, na.rm = TRUE)
promedio3 <- mean(tabla3$revenue, na.rm = TRUE)

df_promedios <- data.frame(
  Categoria = c("Sin homePage y con video", "Con homePage y sin video", "Con homePage y con video"),
  Promedio_Ganancia = c(promedio1, promedio2, promedio3)
)
df_promedios
```

Se ve que la mejor estrategia de marketing son las páginas oficiles sin ofrecer video.

### ¿La popularidad del elenco está directamente correlacionada con el éxito de taquilla?

```{r Pregunta 16}
library(dplyr)
library(tidyr)

datos <- read.csv("data/movies.csv")
succes <- datos %>% filter(revenue > budget * 3)

success <- datos %>% 
  filter(revenue > budget * 3) %>% 
  mutate(actorsPopularity = ifelse(actorsPopularity == "", NA, as.character(actorsPopularity)),
         popularidad_media = sapply(strsplit(actorsPopularity, "\\|"), 
                                    function(x) mean(as.numeric(x), na.rm = TRUE)))

popularity <- head(success[, c('popularidad_media','revenue')],300)
plot(popularity$popularidad_media, popularity$revenue,
     main = "Relación entre Popularidad de actores y Ganancia",
     xlab="Popularidad",
     ylab="Ganancia",
     col="blue",pch=19)
```

Se puede ver que no existe una correlación clara entre la popularidad de los actores de una cinta con su ganacia, esto es incluso más perceptible con el coeficiente de correlación que es cercano a 0: `r cor(popularity$popularidad_media, popularity$revenue, use = "complete.obs")`.

## Preguntas Extras

### ¿Las películas más largas generan mayores ingresos o reciben mejores calificaciones?

```{r Pregunta Extra 1.1}

datos$runtime <- as.numeric(datos$runtime)
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

plot(movies_by_runtime$runtime, movies_by_runtime$revenue, type = "l", xlab = "Duración", ylab = "Ingresos", main= "Duración VS Ingresos")
```

Como se puede ver, las películas más largas no necesariamente implican una mayor cantidad de ingresos, de hecho varias de las películas que han generado grandes cantidades de ingresos son menores en duración a 200 minutos.
Ahora con respecto al rating:

```{r Pregunta Extra 1.2}
datos$runtime <- as.numeric(datos$runtime)
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

plot(movies_by_runtime$runtime, movies_by_runtime$voteCount, type = "l", xlab = "Duración", ylab = "Votos", main= "Duración VS Votos")
```

Como se puede ver por la gráfica, una mayor duración de la película no implica una mayor cantidad de votos.

### ¿Qué países producen más películas?

```{r Pregunta Extra 2}
library(data.table)

# Convert to data.table for efficiency
setDT(movies_by_date)

# Split production countries and unnest
movies_by_date[, productionCountry := strsplit(productionCountry, split = "|", fixed = TRUE)]
movie_countries <- movies_by_date[, .(TITLE = title, COUNTRY = unlist(productionCountry))]

# Count occurrences of each country
movie_countries <- movie_countries[, .(COUNT = .N), by = COUNTRY]

# Order by count and select top 3 countries
movie_countries <- head(movie_countries[order(-COUNT)], n = 3)

# Create bar plot
barplot(setNames(movie_countries$COUNT, movie_countries$COUNTRY), 
        main = "Top 3 países productores de películas", 
        las = 1, col = c("#69b3a2", "#69b300", "#69bfff"))

```

Como se puede ver, el país que produce la mayor cantidad de películas es los Estados Unidos de América y por mucho, ya que en total ha producido `r max(movie_countries$COUNT)` películas.

### ¿Las películas con más géneros combinados tienen mejores ingresos?

```{r Pregunta Extra 3}
library(data.table)
# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(genresAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(-genresAmount)]

# Split genres and unnest
movie_genres <- movies_by_date[, .(GENREAMOUNT = genresAmount, REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = GENREAMOUNT]

# Create bar plot
barplot(setNames(movie_genres$REVENUE, movie_genres$GENRE), 
        main = "Ingresos por cantidad de géneros", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver, más géneros no implica mejores ganancias!
De hecho parece que el sweet spot es 3 géneros.

### ¿Cómo ha evolucionado el presupuesto el presupuesto promedio de las peliculas a lo largo de los años?

```{r Pregunta Extra 4}
datos$releaseDate <- as.Date(datos$releaseDate)
datos$year <- format(datos$releaseDate, "%Y")
datos1 <- datos %>% filter(budget > 0)
budget_year <- datos1 %>% group_by(year) %>% summarise(presupuesto_promedio = mean(budget))

ggplot(budget_year, aes(x = year, y = presupuesto_promedio, group = 1)) + 
  geom_line(color = "blue", size = 1) +
  scale_x_discrete(breaks = budget_year$year[seq(1, length(datos$year), by = 10)]) +
  labs(title = "Presupuesto promedio por año", x = "Año", y = "Presupuesto promedio") +
  theme_minimal()

```

Se puede ver un aumento en el presupuesto a lo largo de los años, lleagndo a su punto más alto a finales de los años 90.
El presupuesto promedio tuvo un leve descenso en este siglo XXI pero ya en años más recientes el presupuesto promedio por año ha estado en ascenso.

### ¿En qué años se han producido las películas con los mayores presupuestos?

```{r Pregunta Extra 5}

datos$year <- format(datos$releaseDate, "%Y")
datosX <- datos[order(datos$budget, decreasing = TRUE),]
budget_year <- head(datosX[, c('year','budget', 'title')],10)
colnames(budget_year)[1] = "Año"
colnames(budget_year)[2] = "Presupuesto"
colnames(budget_year)[3] = "Pelicula"
budget_year
```

Estos serían los años en donde se han producido las peliculas con mayores presupuesto, adjunto a esta información se encuentra el nombre respectivo de la pelicula.

### ¿Cuáles son las compañías productoras más exitosas en términos de ingresos generados?

```{r Pregunta Extra 6}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)

datos1 <- datos %>%
  mutate(productionCompany = ifelse(is.na(productionCompany), "", as.character(productionCompany))) %>%
  mutate(productionCompany = str_squish(productionCompany)) %>%  # Elimina espacios extra
  separate_rows(productionCompany, sep = "\\|") %>%  # Separa en filas individuales
  mutate(productionCompany = str_trim(productionCompany))  # Elimina espacios en cada nombre

companies <- datos1 %>%
  group_by(productionCompany) %>%
  summarise(ingresos = sum(revenue, na.rm = TRUE), total_peliculas = n())

companies <- companies[, c('productionCompany', 'ingresos')]
companies <- head(companies[order(companies$ingresos, decreasing = TRUE), ], 10)
colnames(companies)[1] <- "Compañia productora"

ggplot(companies, aes(x = `Compañia productora`, y = ingresos, fill = `Compañia productora`)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD",
                               "#8C564B", "#E377C2", "#7F7F7F", "#BCBD22", "#17BECF")) +
  theme(axis.text.x = element_blank(),  # Oculta etiquetas del eje X
        axis.ticks.x = element_blank())


```

Estas son las Compañias productoras más exitosas en terminos de los ingresos totales generados.
Es apreciable estudios como "Warner Bros. Pictures" tenga el mayor número de ingresos debido a que es uno de las compañias más longevas y que sigue vigente a día de hoy.
