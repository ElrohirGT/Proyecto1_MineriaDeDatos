---
title: "CineVision - Análisis Exploratorio"
author: "Flavio Galán, José Prince"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Resumen del conjunto de Datos

Los datos tienen la siguiente forma:

```{r}
datos <- read.csv("data/movies.csv")
summary(datos)
```

## Tipos de cada variable

(Prince) (Hay que listar también si siguen una distribución normal y la tabla de frecuencia para las cualitativas).

## Preguntas

(Son 16 más 3 y 3 extras. Las primeras 8+3 Flavio las demás Prince)

### ¿Cuáles son las 10 películas que contaron con más presupuesto?

```{r Pregunta 1}
ordered_movies <- datos[order(datos$budget, decreasing = TRUE),]
top_10_expensive_movies <- head(ordered_movies, n=10)
top_10_expensive_movies <- top_10_expensive_movies[c("title", "budget")]

colnames(top_10_expensive_movies)[1] = "Título"
colnames(top_10_expensive_movies)[2] = "Presupuesto"

top_10_expensive_movies
```

Como se puede ver la película con mayor presupuesto es: `r top_10_expensive_movies$Título[1]` con un presupuesto de: `r top_10_expensive_movies$Presupuesto[1]` dólares!
Mientras que la última película dentro del top 10 es: `r top_10_expensive_movies$Título[10]` con un presupuesto de $`r top_10_expensive_movies$Presupuesto[10]`.

### ¿Cuáles son las 10 películas que más ingresos tuvieron?

```{r Pregunta 2}
ordered_movies <- datos[order(datos$revenue, decreasing = TRUE),]
top_10_expensive_movies <- head(ordered_movies, n=10)
top_10_expensive_movies <- top_10_expensive_movies[c("title", "revenue")]

colnames(top_10_expensive_movies)[1] = "Título"
colnames(top_10_expensive_movies)[2] = "Ingresos"

top_10_expensive_movies
```

Como se puede ver la película con mayores ingresos es: `r top_10_expensive_movies$Título[1]` con una cantidad de: `r top_10_expensive_movies$Ingresos[1]` dólares!
Mientras que la última película dentro del top 10 es: `r top_10_expensive_movies$Título[10]` con un ingresos de $`r top_10_expensive_movies$Ingresos[10]`.

### ¿Cuál es la película que más votos tuvo?

```{r Pregunta 3}
ordered_voted_movies <- datos[order(datos$voteCount, decreasing = TRUE),]
top_voted_movie <- head(ordered_voted_movies, n=1)
```

La película que más votos tuvo es: `r top_voted_movie$title[1]` con una cantidad de votos igual a: `r top_voted_movie$voteCount[1]`.

### ¿Cuál es la peor película de acuerdo a los votos de todos los usuarios?

```{r Pregunta 4}
ordered_voted_movies <- datos[order(datos$voteCount, decreasing = FALSE),]
worst_rated_movie <- head(ordered_voted_movies, n=1)
```

La película que menos votos tuvo es: `r worst_rated_movie$title[1]` con una cantidad de votos igual a: `r worst_rated_movie$voteCount[1]`.

### ¿Cuántas películas se hicieron en cada año? ¿En qué año se hicieron más películas? Haga un gráfico de barras

```{r Pregunta 5}
datos$year <- substr(datos$releaseDate, start = 1, stop = 4)
movies_by_year <- aggregate(datos[,c("year")], by=list(datos$year), FUN="length")

colnames(movies_by_year)[1] = "Año"
colnames(movies_by_year)[2] = "# Películas"

vec <- movies_by_year$`# Películas`
names(vec) <- movies_by_year$Año
barplot(vec, main="Películas por Año", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))

movies_by_year <- movies_by_year[order(movies_by_year$`# Películas`, decreasing = TRUE),]
max_movie_count_in_years <- movies_by_year$`# Películas`[1]

```

La tendencia en general de las películas ha ido en aumento conforme pasan los años, los demás datos de 2000 hacia atrás son más y más bajos.

En el año en donde más películas se han hecho es en el `r movies_by_year$Año[1]` con un total de: `r max_movie_count_in_years` películas que fueron lanzadas al cine.

### ¿Cuál es el género principal de las 20 películas más recientes? ¿Cuál es el género principal que predomina en el conjunto de datos? Represéntelo usando un gráfico.

```{r Pregunta 6.1}
datos$releaseDate <- as.Date(datos$releaseDate)
movies_by_date <- datos[order(datos$releaseDate, decreasing = TRUE),]

recent_movies_20 <- head(movies_by_date, n=20)
splitted_genres <- strsplit(recent_movies_20$genres, split = "|", fixed = TRUE)
movie_genres <- data.frame("", "")
names(movie_genres)<- c("ID", "GENRE")
for (idx in 1:20) {
  for (genre in splitted_genres[[idx]]) {
    temp <- c(recent_movies_20$title[idx], genre)
    names(temp) <- c("ID", "GENRE")
    movie_genres<- rbind(movie_genres, temp)
  }
}
movie_genres <- aggregate(movie_genres[,c("GENRE")], by=list(movie_genres$GENRE), FUN="length")
names(movie_genres) <- c("GENRE", "COUNT")
vec <- movie_genres$COUNT
names(vec) <- movie_genres$GENRE
barplot(vec, main="Géneros en las top 20 películas", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))
```

Los dos géneros más populares entre las últimas 20 películas son Comedia y Drama.
Mientras que en todos los datos:

```{r Pregunta 6.2}
library(data.table)
library(tidyr)

# Convert to data.table for efficiency
setDT(datos)
datos[, releaseDate := as.Date(releaseDate)]

# Order by release date in descending order
movies_by_date <- datos[order(-releaseDate)]

# Split genres and unnest
movies_by_date[, genres := strsplit(genres, split = "|", fixed = TRUE)]
movie_genres <- movies_by_date[, .(ID = title, GENRE = unlist(genres))]

# Count occurrences of each genre
movie_genres <- movie_genres[, .(COUNT = .N), by = GENRE]

# Create bar plot
barplot(setNames(movie_genres$COUNT, movie_genres$GENRE), 
        main = "Géneros generales", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

```

El género principal que predomina en todos los datos es Drama con una cantidad de películas del género igual a `r max(movie_genres$COUNT)`.

**¿A qué género principal pertenecen las películas más largas?**

```{r Pregunta 6.3}
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

limit <- 20
recent_movies_20 <- head(movies_by_runtime, n=limit)
splitted_genres <- strsplit(recent_movies_20$genres, split = "|", fixed = TRUE)
movie_genres <- data.frame("", "")
names(movie_genres)<- c("ID", "GENRE")
for (idx in 1:limit) {
  for (genre in splitted_genres[[idx]]) {
    temp <- c(recent_movies_20$title[idx], genre)
    names(temp) <- c("ID", "GENRE")
    movie_genres<- rbind(movie_genres, temp)
  }
}
movie_genres <- aggregate(movie_genres[,c("GENRE")], by=list(movie_genres$GENRE), FUN="length")
names(movie_genres) <- c("GENRE", "COUNT")
vec <- movie_genres$COUNT
names(vec) <- movie_genres$GENRE
barplot(vec, main="Géneros en las top 20 películas por duración", las=3, col=c("#69b3a2", "#69b300", "#69bfff"))
```

En la gráfica de arriba podemos ver los géneros de las top 20 películas más largas, como se puede ver el género de drama es el más usado y por una gran ventaja.

### ¿Las películas de qué genero principal obtuvieron mayores ganancias?

```{r Pregunta 7}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, releaseDate := as.Date(releaseDate)]

# Order by release date in descending order
movies_by_date <- datos[order(-releaseDate)]

# Split genres and unnest
movies_by_date[, genres := strsplit(genres, split = "|", fixed = TRUE)]
movie_genres <- movies_by_date[, .(TITLE = title, GENRE = unlist(genres), REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = GENRE]

# Create bar plot
barplot(setNames(movie_genres$REVENUE, movie_genres$GENRE), 
        main = "Ingresos por género", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver en la gráfica, el género de película que mayores ingresos genera es Drama seguido de Comedia con $`r max(movie_genres$REVENUE)`y $`r ordered$REVENUE[2]` respectivamente.

### ¿La cantidad de actores influye en los ingresos de las películas? ¿Se han hecho películas con más actores en los últimos años?

```{r Pregunta 8.1}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(actorsAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(actorsAmount)]

# Split genres and unnest
movie_genres <- movies_by_date[, .(ACTORAMOUNT = actorsAmount, REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = ACTORAMOUNT]

# Create bar plot

barplot(setNames(movie_genres$REVENUE, movie_genres$ACTORAMOUNT), 
        main = "Ingresos por cantidad de actores", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]

```

Como se puede ver, una mayor cantidad de actores no implica una mayor cantidad de ingresos sin embargo se tiene un buen punto medio alrededor de 42 actores.

Con respecto a la cantidad de actores por años podemos reflejarlo en el siguiente gráfico:

```{r Pregunta 8.2}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(actorsAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(as.numeric(iconv(year, 'utf-8', 'ascii', sub='')))]

# Split genres and unnest
movie_genres <- movies_by_date[, .(ACTORAMOUNT = actorsAmount, YEAR = year)]

# Aggregate revenue by genre
movie_genres <- tail(movie_genres[, .(ACTORAMOUNT = sum(as.numeric(ACTORAMOUNT), na.rm = TRUE)), by = YEAR], n=30)

# Create bar plot

barplot(setNames(movie_genres$ACTORAMOUNT, movie_genres$YEAR), 
        main = "Cantidad de actores en películas por año", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver por la gráfica de barras la cantidad de actores por año sí ha ido creciendo año por año!
El 2022 no está completo dentro del dataset y por eso tiene resultados tan bajos.

### ¿Es posible que la cantidad de hombres y mujeres en el reparto influya en la popularidad y los ingresos de las películas?

```{r Pregunta 9}
movie_cast <- head(datos[, c('revenue','castMenAmount','castWomenAmount')],300)
movie_cast$diferencia_cast <- as.numeric(movie_cast$castMenAmount) - as.numeric(movie_cast$castWomenAmount)

plot(movie_cast$diferencia_cast, movie_cast$revenue,
     main = "Relación entre Diferencia de Género en el Elenco y Ganancias",
     xlab="Diferencia Hombres - Mujeres",
     ylab="Ganancias",
     col="blue",pch=19)
relation_rev <- cor(movie_cast$diferencia_cast, movie_cast$revenue, use = "complete.obs")

movie_castP <- head(datos[, c('popularity','castMenAmount','castWomenAmount')],300)
movie_castP$diferencia_cast <- as.numeric(movie_cast$castMenAmount) - as.numeric(movie_cast$castWomenAmount)

plot(movie_cast$diferencia_cast, movie_castP$popularity,
     main = "Relación entre Diferencia de Género en el Elenco y Popularidad",
     xlab="Diferencia Hombres - Mujeres",
     ylab="Popularidad",
     col="blue",pch=19)
```

Se puede ver que la correlación entre la diferencia de géneros y las ganancias es `r cor(movie_cast$diferencia_cast, movie_cast$revenue, use = "complete.obs")`, y la correlación entre la diferencia de géneros y la popularidad es `r cor(movie_cast$diferencia_cast, movie_castP$popularity, use = "complete.obs")`. Esto indica que la cantidad de hombres y mujeres no influye en la ganancia ni popularidad de las peliculas.

### ¿Quiénes son los directores que hicieron las 20 películas mejor calificadas?

```{r Pregunta 10}
directors <- head(datos[, c('director','voteAvg')],20)
o_directors <- directors[order(directors$voteAvg, decreasing = TRUE),]
o_directors[, c('director')]
```

Estos son los 20 directores que han dirigido las peliculas mejores calificadas.

### ¿Cómo se correlacionan los presupuestos con los ingresos? ¿Los altos presupuestos significan altos ingresos? Haga los gráficos que necesite, histograma, diagrama de dispersión

```{r Pregunta 11}
incomes <- datos[, c('budget','revenue')]
plot(incomes$budget, incomes$revenue,
     main = "Relación entre Presupuesto y Ganancia",
     xlab="Presupuesto",
     ylab="Ganancia",
     col="blue",pch=19)
```

Se puede encontrar una relación entre el presupuesto y la ganancia. Es apreciable como a mayor presupuesto hay una mayor ganancia en las peliculas. Para corroborar este dato podemos calcular la variable de correlación que es `r cor(incomes$budget, incomes$revenue, use = "complete.obs")`, al ser cercanan a 1 nos inidica una correlación positiva entre el presupuesto y las ganancias. 

### ¿Se asocian ciertos meses de lanzamiento con mejores ingresos?

```{r Pregunta 12}

```

### ¿En qué meses se han visto los lanzamientos con mejores ingresos?¿cuantas películas, en promedio, se han lanzado por mes?

```{r Pregunta 13}

```

### ¿Cómo se correlacionan las calificaciones con el éxito comercial?

```{r Pregunta 14}

```

### ¿Qué estrategias de marketing, como videos promocionales o páginas oficiales, generan mejores resultados?

```{r Pregunta 15}

```

### ¿La popularidad del elenco está directamente correlacionada con el éxito de taquilla?

```{r Pregunta 16}

```

## Preguntas Extras

### ¿Las películas más largas generan mayores ingresos o reciben mejores calificaciones?

```{r Pregunta Extra 1.1}

datos$runtime <- as.numeric(datos$runtime)
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

plot(movies_by_runtime$runtime, movies_by_runtime$revenue, type = "l", xlab = "Duración", ylab = "Ingresos", main= "Duración VS Ingresos")
```

Como se puede ver, las películas más largas no necesariamente implican una mayor cantidad de ingresos, de hecho varias de las películas que han generado grandes cantidades de ingresos son menores en duración a 200 minutos.
Ahora con respecto al rating:

```{r Pregunta Extra 1.2}
datos$runtime <- as.numeric(datos$runtime)
movies_by_runtime <- datos[order(datos$runtime, decreasing = TRUE),]

plot(movies_by_runtime$runtime, movies_by_runtime$voteCount, type = "l", xlab = "Duración", ylab = "Votos", main= "Duración VS Votos")
```

Como se puede ver por la gráfica, una mayor duración de la película no implica una mayor cantidad de votos.

### ¿Qué países producen más películas?

```{r Pregunta Extra 2}
library(data.table)

# Convert to data.table for efficiency
setDT(movies_by_date)

# Split production countries and unnest
movies_by_date[, productionCountry := strsplit(productionCountry, split = "|", fixed = TRUE)]
movie_countries <- movies_by_date[, .(TITLE = title, COUNTRY = unlist(productionCountry))]

# Count occurrences of each country
movie_countries <- movie_countries[, .(COUNT = .N), by = COUNTRY]

# Order by count and select top 3 countries
movie_countries <- head(movie_countries[order(-COUNT)], n = 3)

# Create bar plot
barplot(setNames(movie_countries$COUNT, movie_countries$COUNTRY), 
        main = "Top 3 países productores de películas", 
        las = 1, col = c("#69b3a2", "#69b300", "#69bfff"))

```

Como se puede ver, el país que produce la mayor cantidad de películas es los Estados Unidos de América y por mucho, ya que en total ha producido `r max(movie_countries$COUNT)` películas.

### ¿Las películas con más géneros combinados tienen mejores ingresos?

```{r Pregunta Extra 3}
library(data.table)

# Convert to data.table for efficiency
setDT(datos)
datos[, genresAmount := as.numeric(genresAmount)]

# Order by release date in descending order
movies_by_date <- datos[order(-genresAmount)]

# Split genres and unnest
movie_genres <- movies_by_date[, .(GENREAMOUNT = genresAmount, REVENUE = revenue)]

# Aggregate revenue by genre
movie_genres <- movie_genres[, .(REVENUE = sum(as.numeric(REVENUE), na.rm = TRUE)), by = GENREAMOUNT]

# Create bar plot
barplot(setNames(movie_genres$REVENUE, movie_genres$GENRE), 
        main = "Ingresos por cantidad de géneros", 
        las = 3, col = c("#69b3a2", "#69b300", "#69bfff"))

# Order by revenue
# ordered <- movie_genres[order(-REVENUE)]
```

Como se puede ver, más géneros no implica mejores ganancias!
De hecho parece que el sweet spot es 3 géneros.
